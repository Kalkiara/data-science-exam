---
title: "datasci_exam"
output: html_document
date: "2023-04-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
pacman::p_load(tidyverse,tsibble, ggfortify, feasts, ggplot2, gridExtra, patchwork, fable)
```


# loading data and cleaning

```{r}
data_path <- "../data/top_songs_by_month.csv"

df <- read_csv(data_path)



df_ts <- as_tsibble(df, key = song_name, index = date)
```

```{r}
ggplot(df, aes(date, danceability)) +
  geom_smooth()

ggplot(df, aes(date, energy)) +
  geom_smooth()

ggplot(df, aes(date, acousticness)) +
  geom_smooth()


ggplot(df, aes(date, instrumentalness)) +
  geom_smooth()
```

```{r}
df_agg <- df %>% 
  group_by(date) %>% 
  summarize(dance_mean = mean(danceability),
            energy_mean = mean(energy),
            speechiness_mean = mean(speechiness),
            acousticness_mean = mean(acousticness),
            instrumentalness_mean = mean(instrumentalness),
            liveness_mean = mean(liveness),
            valence_mean = mean(valence),
            ) 

df_agg <- df_agg %>% 
  mutate(month = yearmonth(date))

df_agg_long <- df_agg %>% 
  pivot_longer(., -c('month', 'date'))

df_agg_ts <- ts(data.matrix(df_agg$dance_mean),  start = c(1960, 1), frequency = 12)

#p1 <- autoplot(df_agg_ts, geom = "ribbon")+
  #theme_minimal()
#p1

colors = c("deeppink", "red4", "gold1", "seagreen3", "royalblue3", "darkorange", "darkorchid")

df_agg_long %>% 
  ggplot(aes(x = date, y = value, col = name))+
  geom_line()+
  facet_grid(~name)+
  theme_bw()+
  theme(legend.position = "none")+
  scale_color_manual(values = colors)
```

```{r}
df_ts_agg <- as_tsibble(df_agg, index = month)

df_ts_agg %>% 
  gg_lag(dance_mean, geom = "point", lag = c(12, 24, 36, 120, 240, 360))


```

```{r}
df_ts_agg %>% 
  ACF(dance_mean, lag_max = 720) %>% autoplot(conf.int.fill = colors[1])+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_x_continuous(breaks = seq(0, 720, 12))

df_ts_agg %>% 
  ACF(energy_mean, lag_max = 720) %>% autoplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_x_continuous(breaks = seq(0, 720, 12))

df_ts_agg %>% 
  ACF(speechiness_mean, lag_max = 720) %>% autoplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_x_continuous(breaks = seq(0, 720, 12))

df_ts_agg %>% 
  ACF(acousticness_mean, lag_max = 720) %>% autoplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_x_continuous(breaks = seq(0, 720, 12))

df_ts_agg %>% 
  ACF(instrumentalness_mean, lag_max = 720) %>% autoplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_x_continuous(breaks = seq(0, 720, 12))

df_ts_agg %>% 
  ACF(liveness_mean, lag_max = 720) %>% autoplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_x_continuous(breaks = seq(0, 720, 12))

df_ts_agg %>% 
  ACF(valence_mean, lag_max = 720) %>% autoplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_x_continuous(breaks = seq(0, 720, 12))

```

```{r}
stl_plot <- function(variable, nplot){
  p <- df_ts_agg %>% 
    model(STL(variable ~ trend(window = 35) + season(window = "periodic"),
              robust = T)) %>% 
    components() %>% 
    autoplot()+
    theme_bw()
  
  # Modify the color of the plot
  p_build <- ggplot_build(p)
  p_build$data[[1]]$colour <- colors[nplot]
  p_gtable <- ggplot_gtable(p_build)
  grid.arrange(p_gtable)
}

p1 <- stl_plot(df_ts_agg$acousticness_mean, 1)
p2 <- stl_plot(df_ts_agg$dance_mean, 2)
p3 <- stl_plot(df_ts_agg$energy_mean, 3)
p4 <- stl_plot(df_ts_agg$instrumentalness_mean, 4)
p5 <- stl_plot(df_ts_agg$liveness_mean, 5)
p6 <- stl_plot(df_ts_agg$speechiness_mean, 6)
p7 <- stl_plot(df_ts_agg$valence_mean, 7)

```

```{r}
# forecasting - bad example 

fit_dance <- df_ts_agg %>% 
  model(lm = TSLM(dance_mean ~ trend() + season())) 

report(fit_dance)

fit_dance %>% 
  gg_tsresiduals()

fit_dance %>% forecast(h = 60) %>% autoplot(df_ts_agg)

# Apply Lowess smoothing
# Convert month variable to numeric
df_ts_agg$month_num <- as.numeric(df_ts_agg$month)

# Apply Lowess smoothing
smoothed <- loess(dance_mean ~ month_num, data = df_ts_agg, span = 0.3)

# Generate smoothed values
df_ts_agg$smoothed_dance_values <- predict(smoothed)

plot(df_ts_agg$month_num, df_ts_agg$dance_mean, type = "l", col = "blue", main = "Lowess Smoothing")
lines(df_ts_agg$month_num, df_ts_agg$smoothed_dance_values, col = "red")

```

fourier components, harmonic regression

```{r}
fit <- df_ts_agg %>% 
  model(f1 <- TSLM(dance_mean~trend() + fourier(K = 1)),
        f2 <- TSLM(dance_mean~trend() + fourier(K = 2)),
        f3 <- TSLM(dance_mean~trend() + fourier(K = 3)),
        f4 <- TSLM(dance_mean~trend() + fourier(K = 4)),
        f5 <- TSLM(dance_mean~trend() + fourier(K = 5)),
        f6 <- TSLM(dance_mean~trend() + fourier(K = 6)),
        fs1 <- TSLM(dance_mean~trend() + season() + fourier(K = 1)),
        fs2 <- TSLM(dance_mean~trend() + season() + fourier(K = 2)),
        fs3 <- TSLM(dance_mean~trend() + season() + fourier(K = 3)),
        fs4 <- TSLM(dance_mean~trend() + season() + fourier(K = 4)),
        fs5 <- TSLM(dance_mean~trend() + season() + fourier(K = 5)),
        fs6 <- TSLM(dance_mean~trend() + season() + fourier(K = 6)))

glance(fit) %>% select(.model, r_squared, adj_r_squared, AIC, AICc)
```

```{r}
df_ts_agg %>% 
  model(sf1 <- TSLM(smoothed_dance_values~trend() + fourier(K = 3))) %>% 
  forecast(h = 60) %>% 
  autoplot(df_ts_agg)
```


```{r}
df_ts_agg %>% 
  model(f1 <- TSLM(dance_mean~trend() + fourier(K = 1))) %>% 
  forecast(h = 120) %>% 
  autoplot(df_ts_agg)


```

```{r}
df_ts_agg %>% 
  model(f1 <- TSLM(acousticness_mean~trend() + fourier(K = 1))) %>% 
  forecast(h = 120) %>% 
  autoplot(df_ts_agg)
```

```{r}
df_ts_agg %>% 
  model(f1 <- TSLM(instrumentalness_mean~trend() + fourier(K = 1))) %>% 
  forecast(h = 60) %>% 
  autoplot(df_ts_agg)
 ```

